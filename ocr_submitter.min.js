function OcrSubmitter(r){this.form=$("#"+r),this.progressBar=this.form.find(".progress"),this.previewImg=this.form.find(".preview_img"),this.dropZone=this.form.find(".drop_zone"),this.meta=this.form.find(".meta"),this.result=this.form.find(".result"),this.error=this.form.find(".error"),this.displayError=function(r){this.previewImg.hide(),this.meta.show(),this.progressBar.hide(),this.error.show().find("[data-type='error-msg']").html(r)},this.errorHandler=function(r){switch(r.target.error.code){case r.target.error.NOT_FOUND_ERR:this.displayError("Nie znaleziono pliku!");break;case r.target.error.NOT_READABLE_ERR:this.displayError("Plik niemożliwy do odczytu");break;case r.target.error.ABORT_ERR:break;default:this.displayError("Wystąpił błąd podczas odczytywania pliku.")}},this.updateProgress=function(r,e){r.progressBar.find(".progress-bar").attr("aria-valuenow",e),r.progressBar.find(".progress-bar").width(e+"%"),r.progressBar.find(".progress-bar").html(e+"%")},this.updateLoadImageProgress=function(r,e){if(e.lengthComputable){var t=Math.round(e.loaded/e.total*100*8/10);t<100&&r.updateProgress(r,t)}},this.startReadingFile=function(r){r.updateProgress(r,0),r.dropZone.removeClass("hover"),r.progressBar.show(),r.meta.hide(),r.error.hide(),r.previewImg.hide(),r.result.html('<td colspan="2">Brak wyniku</td>')},this.previewFile=function(r){var e=this,t=new FileReader;t.onerror=this.errorHandler,t.onprogress=function(r){e.updateLoadImageProgress(e,r)},t.onloadstart=function(r){e.startReadingFile(e)},t.onloadend=function(){e.updateProgress(e,85),e.preprocessImage(e,t.result).then(function(r){e.updateProgress(e,90),e.submitImage(e,r).then(function(r){e.updateProgress(e,100),e.progressBar.hide(),e.previewImg.attr("src",t.result),e.previewImg.show();var o=e.sortProperties(r.result).map(function(r){return"<tr><td>"+r[0]+"</td><td>"+r[1]+"</td></tr>"}).join("<br>");e.result.html(o)}).catch(function(r){e.displayError(r)})}).catch(function(r){e.displayError(r)})},r?t.readAsDataURL(r):this.previewImg.attr("src","")},this.sortProperties=function(r){var e=[];for(var t in r)r.hasOwnProperty(t)&&e.push([t,r[t]]);return e.sort(function(r,e){var t=r[0].toLowerCase(),o=e[0].toLowerCase();return t<o?-1:t>o?1:0}),e},this.preprocessImage=function(r,e){return new Promise(function(t,o){r.getImage(e).then(function(e){var o=document.createElement("canvas");r.resizeImage(o,e),r.grayscaleImage(o);var i=o.toDataURL("image/jpeg"),n=r.dataURLToBlob(i);t({url:i,blob:n})}).catch(function(r){o(r)})})},this.grayscaleImage=function(r){for(var e=r.getContext("2d"),t=e.getImageData(0,0,r.width,r.height),o=t.data,i=r.width*r.height*4-1;i>0;i-=4){var n=i-2,a=i-1,s=.3*o[i-3]+.59*o[n]+.11*o[a];o[i-3]=s,o[i-2]=s,o[i-1]=s}e.putImageData(t,0,0)},this.getImage=function(r){return new Promise(function(e,t){var o=new Image;o.onload=function(){e(o)},o.onerror=function(r){t(r.responseText)},o.src=r})},this.resizeImage=function(r,e){var t=e.width,o=e.height;t>o?t>3e3&&(o*=3e3/t,t=3e3):o>3e3&&(t*=3e3/o,o=3e3),r.width=t,r.height=o,r.getContext("2d").drawImage(e,0,0,t,o)},this.submitImage=function(r,e){return new Promise(function(t,o){console.log(r.form);var i=new FormData(r.form[0]);i.append("docfile",e.blob,"file.jpg"),$.ajax({url:r.form[0].action,type:r.form[0].method,data:i,crossDomain:!0,processData:!1,contentType:!1,cache:!1,success:function(r){t(r)},error:function(r){o(r.responseText)}})})},this.dataURLToBlob=function(r){var e=";base64,";if(-1==r.indexOf(e)){var t=(i=r.split(","))[0].split(":")[1],o=i[1];return new Blob([o],{type:t})}t=(i=r.split(e))[0].split(":")[1];for(var i,n=(o=window.atob(i[1])).length,a=new Uint8Array(n),s=0;s<n;++s)a[s]=o.charCodeAt(s);return new Blob([a],{type:t})},this.Run=function(){var r=this;this.form.find(".choose_file").find("input").on("change",function(e){r.previewFile(e.originalEvent.target.files[0])}),this.dropZone.on("dragover",function(){return $(this).addClass("hover"),!1}),this.dropZone.on("dragleave",function(){return $(this).removeClass("hover"),!1}),this.dropZone.on("drop",function(e){e.preventDefault(),e.stopPropagation(),r.previewFile(e.originalEvent.dataTransfer.files[0])})}}